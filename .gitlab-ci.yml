stages:
  - update
  - build
update-dockerfile:
  stage: update
  image: registry.ocnr.org/infra/repo-updater:latest
  id_tokens:
    VAULT_ID_TOKEN:
      aud: https://vault.ocnr.org
  before_script:
    - |
      set -e
      export VAULT_TOKEN=$(vault write -field=token auth/jwt/login role=repo-updater jwt="${VAULT_ID_TOKEN}")
      export ACCESS_TOKEN=$(vault kv get -field=access_token "repo-updater/${CI_PROJECT_PATH}")
  script:
    - update-dockerfile-commit
  rules:
    - if: $CI_PIPELINE_SOURCE == 'schedule'
build:
  stage: build
  image: registry.ocnr.org/infra/repo-builder:latest
  id_tokens:
    VAULT_ID_TOKEN:
      aud: https://vault.ocnr.org
  before_script:
    - |
      set -e
      export VAULT_TOKEN=$(vault write -field=token auth/jwt/login role=repo-builder jwt="${VAULT_ID_TOKEN}")
      vault kv get -field=config.json ocnr/registries > /secrets/config.json
      export ACCESS_TOKEN=$(vault kv get -field=access_token "repo-builder/${CI_PROJECT_PATH}")
  script:
    - |
      set -e

      if [[ -z "${CI_COMMIT_TAG}" ]]; then
        CI_APPLICATION_REPOSITORY="${CI_REGISTRY_IMAGE}/${CI_COMMIT_REF_SLUG}"
        CI_APPLICATION_TAG="${CI_COMMIT_SHA}"
      else
        CI_APPLICATION_REPOSITORY="${CI_REGISTRY_IMAGE}"
        CI_APPLICATION_TAG="${CI_COMMIT_TAG}"
      fi

      IMAGE_TAGGED="${CI_APPLICATION_REPOSITORY}:${CI_APPLICATION_TAG}"
      IMAGE_LATEST="${CI_APPLICATION_REPOSITORY}:latest"

      buildah build -t "${IMAGE_TAGGED}" -t "${IMAGE_LATEST}"
      buildah login -u access-token -p "${ACCESS_TOKEN}" "${CI_REGISTRY}"
      buildah push "${IMAGE_TAGGED}"
      buildah push "${IMAGE_LATEST}"
  rules:
    - if: $CI_PIPELINE_SOURCE == 'schedule'
      when: never
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH
